<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./public/css/bootstrap.css">
    <title>Hortfruit Online :: Carrinho de Compra</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./public/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./public/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./public/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="./public/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="./public/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="./public/img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="./public/img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
      <!-- Inclua o jQuery aqui -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <!-- Inclua o script de validação depois do jQuery -->

    <title>Hortfruit Online:: Fechamento da Compra</title>
</head>
<style>
    input[type="number"] {
        -webkit-appearance: textfield;
        -moz-appearance: textfield;
        appearance: textfield;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
    }

    .number-input {
        border: 2px solid #ddd;
        display: inline-flex;
        border-radius: 5px;
    }

    .number-input,
    .number-input * {
        box-sizing: border-box;
    }

    .number-input button {
        outline: none;
        -webkit-appearance: none;
        background-color: transparent;
        border: none;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;

        cursor: pointer;
        margin: auto 0;
        position: relative;
    }

    .number-input button:after {
        display: inline-block;
        position: absolute;
        font-family: "Font Awesome 5 Free";
        font-weight: bold;
        transform: translate(-50%, -50%) rotate(180deg);
    }



    .number-input input[type=number] {
        font-family: sans-serif;
        max-width: 3rem;
        padding: .5rem;
        border: solid #ddd;
        border-width: 0 2px;
        font-size: 1rem;
        height: 2rem;
        font-weight: bold;
        text-align: center;
    }
    .checkbox {
  display: none;
}

    .checkbox:checked + label {
  font-weight: bold;
}
.checkbox:checked + label:before {
  background: #005700;
}
.checkbox + label:before {
  content: '';
  display: inline-block;
  width: 1em;
  height: 1em;
  border-radius: 10px;
  margin-right: 15px;
  border: 2px solid #015501;
  margin-bottom: -2px;
  
}

.checkdiv::after{
    border-color: #0aad0a;
}

    
</style>

<body class="bg-light">
    <div class="d-flex flex-column wrapper">
        <nav class="navbar navbar-expand-lg navbar-dark bg-success px-4"
            style="box-shadow: 2px 2px 2px 1px rgba(0, 0, 0, 0.2);">
            <div>
                <!-- img -->
                <a href="#modalLogo">
                    <img src="./public/img/favicon/favicon.ico" style="height: 48px;" alt="logo_loja"
                        class="rounded-circle icon-shape icon-xxl">
                </a>
            </div>
            <a class="navbar-brand mx-2" href="">
                <strong>Hortfruit Online</strong>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-collapse collapse">
                <ul class="navbar-nav flex-grow-1">
                    <li class="nav-item">
                        <a href="/" class="nav-link text-white">Principal</a>
                    </li>
                    <li class="nav-item">
                        <a href="/contato" class="nav-link text-white">Contato</a>
                    </li>
                </ul>
                <div class="align-self-end">

                    <ul class="navbar-nav">

                        <!-- img -->
                        <li class="nav-item">
                            <a id="editarAvatar" type="button" data-bs-toggle="modal" data-bs-target="#editarAvatar"
                                onclick="editarAvatar()">
                                <img src="./public/img/favicon/avatar-10.jpg" style="height: 40px;" alt="logoAvatar"
                                    class="rounded-circle icon-shape icon-xxl">
                            </a>

                        </li>
                        <li class="nav-item">
                            <a href="/cadastro" class="nav-link text-white" id="user-link">Quero Me Cadastrar</a>
                        </li>
                        <li class="nav-item">
                            <a href="/login" class="nav-link text-white" id="auth-link">Entrar</a>
                        </li>

                        <li class="nav-item">
                            <a href="/carrinho" class="nav-link text-white">
                                <svg class="bi" width="24" height="24" fill="currentColor">
                                    <use xlink:href="/bi.svg#cart3" />
                                </svg>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <main class="flex-fill bg-light">
            <div class="container">

                <div class="my-4 pb-5">

                </div>
                
                <div class="row">
                    <div class="col-lg-8 col-md-7">
                        <div class="py-3">
                            <!-- alert -->
                            <div class="col-md-10 order-md-1">
                                <section class="bg-white p-4 mb-3">
                                    <h4 class="mb-3">Endereço de Cobrança</h4>
                                    <form class="formCompra">
                                        <div class="mb-3">
                                            <label class="form-label" for="email">E-mail</label>
                                            <input type="email" class="form-control" id="email" placeholder="nome@email.com">
                                            <div class="invalid-feedback">
                                                Insira um endereço de e-mail válido para atualizações de envio.
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label" for="endereco">Endereço</label>
                                            <input type="text" class="form-control" id="endereco" placeholder="Rua Principal 1234" required="">
                                            <div class="invalid-feedback">
                                                Favor inserir seu endereço de entrega.
                                            </div>
                                        </div>
                                        <hr class="mb-3">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="same-address">
                                            <label class="custom-control-label" for="same-address">O endereço de entrega é igual ao meu endereço de cobrança</label>
                                        </div>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="save-info">
                                            <label class="custom-control-label" for="save-info">Salve essas informações para a próxima vez</label>
                                        </div>
                                    </section>
                                    <section class="bg-white p-4">
                                        <h4 class="mb-2">Forma de Pagamento</h4>
                                        <div class="d-block my-3">
                                            <div class="custom-control custom-radio" style="border-radius: 5px; border-color: rgb(153, 153, 153); border-style: inset; border-width: 1px; padding: 10px 10px;">
                                                <input id="credit" name="paymentMethod" type="radio" class="checkbox" required="">
                                                <label class="custom-control-label" style="font-size: larger; margin-left: 10px; color: #2b2b2b;" for="credit">Cartão de crédito</label>
                                            </div>
                                            <div class="custom-control custom-radio my-3" style="border-radius: 5px; border-color: rgb(153, 153, 153); border-style: inset; border-width: 1px; padding: 10px 10px;">
                                                <input id="paypal" name="paymentMethod" type="radio" class="checkbox custom-control-input" required="">
                                                <label class="custom-control-label" for="paypal" style="font-size: larger; margin-left: 10px; color: #2b2b2b;">PayPal</label>
                                            </div>
                                            <div class="custom-control custom-radio my-3" style="border-radius: 5px; border-color: rgb(153, 153, 153); border-style: inset; border-width: 1px; padding: 10px 10px;">
                                                <input id="pix" name="paymentMethod" type="radio" class="checkbox" required="">
                                                <label class="custom-control-label" for="pix" style="font-size: larger; margin-left: 10px; color: #2b2b2b;">Pix</label>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="cartaoNome">Nome no cartão</label>
                                                <input type="text" class="form-control" id="cartaoNome" placeholder="" required="">
                                                <small class="text-muted">Nome completo conforme exibido no cartão</small>
                                                <div class="invalid-feedback">
                                                    O nome no cartão é obrigatório
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="cartaoNumero">Número do cartão de crédito</label>
                                                <input type="text" class="form-control" id="cartaoNumero" placeholder="" required="">
                                                <div class="invalid-feedback">
                                                    O número do cartão de crédito é obrigatório
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="cartaoExpiracao">Expiração</label>
                                                <input type="text" class="form-control" id="cartaoExpiracao" placeholder="" required="">
                                                <div class="invalid-feedback">
                                                    Data de validade necessária
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="cartaoCodigo">CVV</label>
                                                <input type="text" class="form-control" id="cartaoCodigo" placeholder="" required="">
                                                <div class="invalid-feedback">
                                                    Código de segurança obrigatório
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    <hr class="mb-4">
                                    <div class="d-flex justify-content-between mb-4">
                                        <a href="/" class="btn p-2 text-light" style="background-color: #0aad0a;">Continue comprando</a>
                                        <button class="btn text-light" style="background-color: rgb(1, 1, 34);" type="submit" id="finalizarCompra">Continuar para finalizar a compra</button>
                                    </div>
                                </form>
                            </div>                            
                          
                        </div>
                    </div>
                    <!-- sidebar -->
                    <div class="col-12 col-lg-4 col-md-5">
                        <!-- card -->
                        <div class="mb-5 card mt-5">
                            <div class="card-body p-6">
                                <!-- heading -->
                                <h2 class="h5 mb-4">Resumo</h2>
                                <div class="card mb-2">
                                    <!-- list group -->
                                    <ul class="list-group list-group-flush">
                                        <!-- list group item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="me-auto">
                                                <div>Subtotal do item</div>
                                            </div>
                                            <span id="subtotal">$0.00</span>
                                        </li>
                                        <!-- list group item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="me-auto">
                                                <div>Taxa de serviço</div>
                                            </div>
                                            <span id="taxa-servico">0.00</span>
                                        </li>
                                        <!-- list group item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="me-auto">
                                                <div class="fw-bold">Total</div>
                                            </div>
                                            <span id="total" class="fw-bold">$3.00</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="d-grid mb-1 mt-4">
                                    <!-- btn -->
                                    <a href="/carrinho"class="btn text-light btn-lg " type="submit" style="background-color: #0aad0a;">
                                       Voltar aos Itens <span id="total-btn" class="fw-bold">$0.00</span>
                                    </a>
                                </div>
                                <!-- text -->
                                <p><small>Ao fazer seu pedido, você concorda em obedecer aos <a href="#!" style="color: #0aad0a; text-decoration: none;">Termos de Serviço</a>
                                    e <a href="#!" style="color: #0aad0a; text-decoration: none;">Política de Privacidade do Hortfruit Online.</a> </small>
                                </p>
                                <!-- heading -->
                                <div class="mt-8">
                                    <h2 class="h5 mb-3">Adicionar promoção ou vale-presente</h2>
                                    <form>
                                        <div class="mb-2">
                                            <!-- input -->
                                            <label for="giftcard" class="form-label sr-only"> Endereço de email</label>
                                            <input type="text" class="form-control" id="giftcard" placeholder="Promoção ou vale-presente">
                                        </div>
                                        <!-- btn -->
                                        <div class="d-grid"><button type="submit" class="btn btn-outline-dark mb-1">Resgatar</button></div>
                                        <p class="text-muted mb-0"> <small>Termos & Condições se aplicam</small></p>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </main>


        <footer class="border-top text-muted " style="z-index: 1000; background-color: rgb(235, 235, 235);">
            <div class="container">
                <div class="row py-3">
                    <div class="col-12 col-md-4 text-center text-md-left">
                        &copy; 2020 - Hortfruit Online Ltda ME<br>
                        Rua Malaguti, 179, Hortlândia <br>
                        CPNJ 99.999.999/0001-99
                    </div>
                    <div class="col-12 col-md-4 text-center">
                        <a href="/privacidade.html" class="text-decoration-none text-dark">Política de
                            Privacidade</a><br>
                        <a href="/termos.html" class="text-decoration-none text-dark">Termos de Uso</a><br>
                        <a href="/quemsomos.html" class="text-decoration-none text-dark">Quem Somos</a><br>
                        <a href="/trocas.html" class="text-decoration-none text-dark">Trocas e Devoluções</a>
                    </div>
                    <div class="col-12 col-md-4 text-center text-md-right">
                        <a href="/contato.html" class="text-decoration-none text-dark">Contato pelo site</a><br>
                        E-mail: <a href="mailto:email@dominio.com"
                            class="text-decoration-none text-dark">email@dominio.com</a><br>
                        Telefone: <a href="phone:28999990000" class="text-decoration-none text-dark">(27) 99999-9999</a>
                    </div>
                </div>
                <div class="border-top py-4">
                    <div class="row align-items-center">
                        <div class="col-lg-5 text-lg-start text-center mb-2 mb-lg-0">
                            <ul class="list-inline mb-0">
                                <li class="list-inline-item text-dark">Parceiros de pagamento</li>
                                <li class="list-inline-item">
                                    <a href="#!"><img src="./public/img/favicon/amazonpay.svg" alt=""></a>
                                </li>
                                <li class="list-inline-item">
                                    <a href="#!"><img src="./public/img/favicon/american-express.svg" alt=""></a>
                                </li>
                                <li class="list-inline-item">
                                    <a href="#!"><img src="./public/img/favicon/mastercard.svg" alt=""></a>
                                </li>
                                <li class="list-inline-item">
                                    <a href="#!"><img src="./public/img/favicon/paypal.svg" alt=""></a>
                                </li>
                                <li class="list-inline-item">
                                    <a href="#!"><img src="./public/img/favicon/visa.svg" alt=""></a>
                                </li>
                            </ul>
                        </div>
                        <div class="col-lg-7 mt-4 mt-md-0">
                            <ul class="list-inline mb-0 text-lg-end text-center">
                                <li class="list-inline-item mb-2 mb-md-0 text-dark">Obtenha entregas com Hprtfruit
                                    Online</li>
                                <li class="list-inline-item ms-4">
                                    <a href="#!"> <img src="./public/img/favicon/appstore-btn.svg" alt=""
                                            style="width: 140px;"></a>
                                </li>
                                <li class="list-inline-item">
                                    <a href="#!"> <img src="./public/img/favicon/googleplay-btn.svg" alt=""
                                            style="width: 140px;"></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr>
                </div>

            </div>
        </footer>
    </div>

    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
    const acceptedCreditCards = {
        visa: /^4[0-9]{12}(?:[0-9]{3})?$/,
        mastercard: /^5[1-5][0-9]{14}$|^2(?:2(?:2[1-9]|[3-9][0-9])|[3-6][0-9][0-9]|7(?:[01][0-9]|20))[0-9]{12}$/,
        amex: /^3[47][0-9]{13}$/,
        discover: /^65[4-9][0-9]{13}|64[4-9][0-9]{13}|6011[0-9]{12}|(622(?:12[6-9]|1[3-9][0-9]|[2-8][0-9][0-9]|9[01][0-9]|92[0-5])[0-9]{10})$/,
        diners_club: /^3(?:0[0-5]|[68][0-9])[0-9]{11}$/,
        jcb: /^(?:2131|1800|35[0-9]{3})[0-9]{11}$/,
    };
    

    const cartaoNome = document.getElementById('cartaoNome');
    const cartaoNumero = document.getElementById('cartaoNumero');
    const cartaoExpiracao = document.getElementById('cartaoExpiracao');
    const cartaoCodigo = document.getElementById('cartaoCodigo');
    const finalizarCompra = document.getElementById('finalizarCompra');


    function validateCard(value) {
        value = value.replace(/\D/g, '');
        let sum = 0;
        let shouldDouble = false;

        for (let i = value.length - 1; i >= 0; i--) {
            let digit = parseInt(value.charAt(i));
            if (shouldDouble) {
                if ((digit *= 2) > 9) digit -= 9;
            }
            sum += digit;
            shouldDouble = !shouldDouble;
        }

        let valid = (sum % 10) == 0;
        let accepted = false;

        Object.keys(acceptedCreditCards).forEach(function(key) {
            let regex = acceptedCreditCards[key];
            if (regex.test(value)) {
                accepted = true;
            }
        });

        return valid && accepted;
    }

   
    function validateCVV(creditCard, cvv) {
        creditCard = creditCard.replace(/\D/g, '');
        cvv = cvv.replace(/\D/g, '');
        if ((acceptedCreditCards.amex).test(creditCard)) {
            return (/^\d{3}$/).test(cvv);
        } else {
            return (/^\d{4}$/).test(cvv);
        }
    }

    function formatCardNumber(value) {
        value = value.replace(/\D/g, '');
        let formattedValue;
        let maxLength;

        if ((/^3[47]\d{0,13}$/).test(value)) {
            formattedValue = value.replace(/(\d{4})/, '$1 ').replace(/(\d{4}) (\d{6})/, '$1 $2 ');
            maxLength = 17;
        } else if ((/^3(?:0[0-5]|[68]\d)\d{0,11}$/).test(value)) {
            formattedValue = value.replace(/(\d{4})/, '$1 ').replace(/(\d{4}) (\d{6})/, '$1 $2 ');
            maxLength = 16;
        } else if ((/^\d{0,16}$/).test(value)) {
            formattedValue = value.replace(/(\d{4})/, '$1 ').replace(/(\d{4}) (\d{4})/, '$1 $2 ').replace(/(\d{4}) (\d{4}) (\d{4})/, '$1 $2 $3 ');
            maxLength = 19;
        }

        cartaoNumero.setAttribute('maxlength', maxLength);
        return formattedValue;
    }

    function validatePaymentDetails() {
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;
        const nome = cartaoNome.value;
        const numero = cartaoNumero.value;
        const expiracao = cartaoExpiracao.value;
        const codigo = cartaoCodigo.value;

        if (paymentMethod === 'credit') {
            if (!nome) {
                alert('O nome no cartão é obrigatório');
                return false;
            }
            if (!numero || !validateCard(numero)) {
                alert('O número do cartão de crédito é obrigatório e deve ser válido');
                return false;
            }
            if (!expiracao || !/^(0[1-9]|1[0-2])\/?([0-9]{4}|[0-9]{2})$/.test(expiracao)) {
                alert('Data de expiração inválida. Use o formato MM/AA');
                return false;
            }
            // if (!codigo || !validateCVV(numero, codigo)) {
            //     alert('O código de segurança é obrigatório e deve ser válido');
            //     return false;
            // }
        }
        return true;
    }

    $('#cartaoNumero, #cartaoCodigo').on('input', function() {
        if (validateCard(cartaoNumero.value) && validateCVV(cartaoNumero.value, cartaoCodigo.value)) {
            finalizarCompra.disabled = true;
        } else {
            finalizarCompra.disabled = false;
        }

        let node = cartaoNumero; 
        let cursor = node.selectionStart; 
        let lastValue = cartaoNumero.value; 

        let formattedValue = formatCardNumber(lastValue);
        cartaoNumero.value = formattedValue; 

        if (cursor === lastValue.length) {
            cursor = formattedValue.length;
            if (cartaoNumero.getAttribute('data-lastvalue') && cartaoNumero.getAttribute('data-lastvalue').charAt(cursor - 1) == " ") {
                cursor--;
            }
        }

        if (lastValue != formattedValue) {
            if (lastValue.charAt(cursor) == " " && formattedValue.charAt(cursor - 1) == " ") {
                cursor++;
            }
        }

        node.selectionStart = cursor;
        node.selectionEnd = cursor;
        cartaoNumero.setAttribute('data-lastvalue', formattedValue);
    });

    finalizarCompra.addEventListener('click', async function(event) {
        event.preventDefault();

        const email = document.getElementById('email').value;
        const endereco = document.getElementById('endereco').value;
        const sameAddress = document.getElementById('same-address').checked;
        const saveInfo = document.getElementById('save-info').checked;
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;

        if (!validatePaymentDetails()) {
            return;
        }

        try {
            const userResponse = await fetch(`/usuario/user/${email}`);
            const userData = await userResponse.json();

            if (!userResponse.ok) {
                throw new Error(userData.message || 'Erro ao obter usuário');
            }

            const userId = userData.userId;
            const carrinhoResponse = await fetch(`/carrinho/total/${userId}`);
            const carrinhoData = await carrinhoResponse.json();

            if (!carrinhoResponse.ok || carrinhoData.total === null) {
                throw new Error('Carrinho vazio ou erro ao obter total do carrinho');
            }

            const valorTotal = carrinhoData.total;
            const pagamentoResponse = await fetch('/pagamento/processar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tipo: paymentMethod,
                    numCartao: cartaoNumero.value,
                    dataExpiracao: cartaoExpiracao.value,
                    codigoSeguranca: cartaoCodigo.value,
                    valor: valorTotal
                })
            });

            const pagamentoData = await pagamentoResponse.json();

            if (!pagamentoResponse.ok) {
                throw new Error(pagamentoData.message || 'Erro ao processar pagamento');
            }

            const pagamentoId = pagamentoData.id;
            const pedidoResponse = await fetch('/pedido/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId,
                    pagamentoId
                })
            });

            const pedidoData = await pedidoResponse.json();

            if (!pedidoResponse.ok) {
                throw new Error(pedidoData.message || 'Erro ao criar pedido');
            }

            await fetch(`/carrinho/clear/${userId}`, {
                method: 'DELETE'
            });

            window.location.href = `pedido.html?pedidoId=${pedidoData.pedidoId}`;

        } catch (error) {
            console.error('Erro:', error);
            alert('Ocorreu um erro ao finalizar a compra. Tente novamente.');
        }
    });

    function updateSidebar() {
        const subtotalElement = document.getElementById('subtotal');
        const taxaServicoElement = document.getElementById('taxa-servico');
        const totalElement = document.getElementById('total');
        const totalBtnElement = document.getElementById('total-btn');

        const subtotal = parseFloat(localStorage.getItem('subtotal')) || 0;
        const taxaServico = 2.99; 
        const total = subtotal + taxaServico;

        if (subtotalElement && taxaServicoElement && totalElement && totalBtnElement) {
            subtotalElement.innerText = `R$ ${subtotal.toFixed(2)}`;
            taxaServicoElement.innerText = `R$ ${taxaServico.toFixed(2)}`;
            totalElement.innerText = `R$ ${total.toFixed(2)}`;
            totalBtnElement.innerText = `R$ ${total.toFixed(2)}`;
        }
    }
    
    

    updateSidebar();
});

</script>
     <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>